syntax = "proto3";

package hivemind.notes;

import "common.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/devilmonastery/hivemind/api/generated/go/notespb";

// NoteService manages private user notes
service NoteService {
  // CreateNote creates a new note
  rpc CreateNote(CreateNoteRequest) returns (Note);

  // GetNote retrieves a note by ID (must be owned by caller)
  rpc GetNote(GetNoteRequest) returns (Note);

  // ListNotes lists user's notes with optional filtering
  rpc ListNotes(ListNotesRequest) returns (ListNotesResponse);

  // UpdateNote updates an existing note (must be owned by caller)
  rpc UpdateNote(UpdateNoteRequest) returns (Note);

  // DeleteNote soft-deletes a note (must be owned by caller)
  rpc DeleteNote(DeleteNoteRequest) returns (hivemind.common.v1.SuccessResponse);

  // SearchNotes searches user's notes by full-text query
  rpc SearchNotes(SearchNotesRequest) returns (SearchNotesResponse);

  // AutocompleteNoteTitles returns all note titles for a user (bot filters locally)
  rpc AutocompleteNoteTitles(AutocompleteNoteTitlesRequest) returns (AutocompleteNoteTitlesResponse);

  // AddNoteMessageReference adds a Discord message reference to a note
  rpc AddNoteMessageReference(AddNoteMessageReferenceRequest) returns (NoteMessageReference);

  // ListNoteMessageReferences lists all message references for a note
  rpc ListNoteMessageReferences(ListNoteMessageReferencesRequest) returns (ListNoteMessageReferencesResponse);
}

// Note represents a private user note with optional context
message Note {
  string id = 1;
  string title = 2; // Optional
  string body = 3;

  // Ownership
  string author_id = 4;
  string author_username = 5;

  // Context (optional)
  string guild_id = 6; // NULL for personal notes
  string guild_name = 7; // Guild display name
  string channel_id = 8;
  string channel_name = 9;

  // Reference (optional)
  string source_msg_id = 10; // Message that inspired this note
  string source_channel_id = 11;
  repeated string mentioned_user_ids = 12; // Discord user IDs mentioned

  // Metadata
  repeated string tags = 13;

  // Timestamps
  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
}

message CreateNoteRequest {
  string title = 1; // Optional
  string body = 2;
  string guild_id = 3; // Optional: NULL for personal notes
  string channel_id = 4; // Optional
  string source_msg_id = 5; // Optional
  repeated string tags = 6;
}

message GetNoteRequest {
  string id = 1;
}

message ListNotesRequest {
  string guild_id = 1; // Optional: filter by guild, omit for all notes
  repeated string tags = 2; // Optional: filter by tags
  int32 limit = 3; // Default: 50
  int32 offset = 4;
  string order_by = 5; // "created_at", "updated_at"
  bool ascending = 6;
}

message ListNotesResponse {
  repeated Note notes = 1;
  int32 total = 2;
}

message UpdateNoteRequest {
  string id = 1;
  string title = 2;
  string body = 3;
  repeated string tags = 4;
}

message DeleteNoteRequest {
  string id = 1;
}

message SearchNotesRequest {
  string query = 1; // Full-text search query
  string guild_id = 2; // Optional: filter by guild
  repeated string tags = 3; // Optional: filter by tags
  int32 limit = 4; // Default: 10
  int32 offset = 5;
}

message SearchNotesResponse {
  repeated Note notes = 1;
  int32 total = 2;
}

message AutocompleteNoteTitlesRequest {
  string guild_id = 1; // Optional: filter by guild
}

message AutocompleteNoteTitlesResponse {
  repeated NoteTitleSuggestion suggestions = 1;
}

message NoteTitleSuggestion {
  string id = 1;
  string title = 2;
}

// AttachmentMetadata stores Discord attachment information
message AttachmentMetadata {
  string url = 1;
  string content_type = 2; // MIME type (e.g., "image/png", "video/mp4")
  string filename = 3;
  int32 width = 4; // For images/videos
  int32 height = 5; // For images/videos
  int64 size = 6; // File size in bytes
}

// NoteMessageReference represents a Discord message referenced in a note
message NoteMessageReference {
  string id = 1;
  string note_id = 2;
  string message_id = 3;
  string channel_id = 4;
  string guild_id = 5; // Nullable for DM contexts
  string content = 6;
  string author_id = 7;
  string author_username = 8;
  string author_display_name = 9;
  string author_guild_avatar_hash = 10; // Guild-specific avatar hash
  string author_user_avatar_hash = 15; // Global user avatar hash
  google.protobuf.Timestamp message_timestamp = 11;
  repeated AttachmentMetadata attachments = 12;
  google.protobuf.Timestamp added_at = 13;
  string discord_link = 14; // Computed: Discord message URL
}

message AddNoteMessageReferenceRequest {
  string note_id = 1;
  string message_id = 2;
  string channel_id = 3;
  string guild_id = 4; // Optional
  string content = 5;
  string author_id = 6;
  string author_username = 7;
  string author_display_name = 8;
  google.protobuf.Timestamp message_timestamp = 9;
  repeated AttachmentMetadata attachments = 10;
}

message ListNoteMessageReferencesRequest {
  string note_id = 1;
}

message ListNoteMessageReferencesResponse {
  repeated NoteMessageReference references = 1;
}
