syntax = "proto3";

package hivemind.wiki;

import "common.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/devilmonastery/hivemind/api/generated/go/wikipb";

// WikiService manages guild knowledge base articles
service WikiService {
  // CreateWikiPage creates a new wiki page in a guild
  rpc CreateWikiPage(CreateWikiPageRequest) returns (WikiPage);

  // GetWikiPage retrieves a wiki page by ID
  rpc GetWikiPage(GetWikiPageRequest) returns (WikiPage);

  // SearchWikiPages searches for wiki pages in a guild
  rpc SearchWikiPages(SearchWikiPagesRequest) returns (SearchWikiPagesResponse);

  // AutocompleteWikiTitles returns all wiki page titles for a guild (bot filters locally)
  rpc AutocompleteWikiTitles(AutocompleteWikiTitlesRequest) returns (AutocompleteWikiTitlesResponse);

  // UpdateWikiPage updates an existing wiki page
  rpc UpdateWikiPage(UpdateWikiPageRequest) returns (WikiPage);

  // UpsertWikiPage creates or updates a wiki page by title
  rpc UpsertWikiPage(UpsertWikiPageRequest) returns (UpsertWikiPageResponse);

  // DeleteWikiPage soft-deletes a wiki page
  rpc DeleteWikiPage(DeleteWikiPageRequest) returns (hivemind.common.v1.SuccessResponse);

  // ListWikiPages lists all wiki pages in a guild with pagination
  rpc ListWikiPages(ListWikiPagesRequest) returns (ListWikiPagesResponse);

  // AddWikiMessageReference tags a Discord message with a wiki page topic
  rpc AddWikiMessageReference(AddWikiMessageReferenceRequest) returns (WikiMessageReference);

  // ListWikiMessageReferences retrieves all message references for a wiki page
  rpc ListWikiMessageReferences(ListWikiMessageReferencesRequest) returns (ListWikiMessageReferencesResponse);
}

// WikiPage represents a guild knowledge base article
message WikiPage {
  string id = 1;
  string title = 2;
  string body = 3;

  // Ownership
  string author_id = 4;
  string author_username = 5;
  string guild_id = 6;
  string guild_name = 7; // Guild display name
  string channel_id = 8;
  string channel_name = 9;

  // Metadata
  repeated string tags = 10;
  repeated string linked_page_ids = 11;

  // Timestamps
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

message CreateWikiPageRequest {
  string title = 1;
  string body = 2;
  string guild_id = 3;
  string channel_id = 4; // Optional: channel where created
  repeated string tags = 5;
}

message GetWikiPageRequest {
  string id = 1;
}

message SearchWikiPagesRequest {
  string guild_id = 1;
  string query = 2; // Full-text search query
  repeated string tags = 3; // Filter by tags
  int32 limit = 4; // Default: 10
  int32 offset = 5;
}

message SearchWikiPagesResponse {
  repeated WikiPage pages = 1;
  int32 total = 2;
}

message UpdateWikiPageRequest {
  string id = 1;
  string title = 2;
  string body = 3;
  repeated string tags = 4;
}

message UpsertWikiPageRequest {
  string title = 1;
  string body = 2;
  string guild_id = 3;
  string channel_id = 4; // Optional: channel where created/updated
  repeated string tags = 5;
}

message UpsertWikiPageResponse {
  WikiPage page = 1;
  bool created = 2; // true if created, false if updated
}

message DeleteWikiPageRequest {
  string id = 1;
}

message ListWikiPagesRequest {
  string guild_id = 1;
  int32 limit = 2; // Default: 50
  int32 offset = 3;
  string order_by = 4; // "created_at", "updated_at", "title"
  bool ascending = 5;
}

message ListWikiPagesResponse {
  repeated WikiPage pages = 1;
  int32 total = 2;
}

message AutocompleteWikiTitlesRequest {
  string guild_id = 1; // Required: guild context
}

message AutocompleteWikiTitlesResponse {
  repeated WikiTitleSuggestion suggestions = 1;
}

message WikiTitleSuggestion {
  string id = 1;
  string title = 2;
}

// WikiMessageReference represents a Discord message tagged with a wiki page topic
message WikiMessageReference {
  string id = 1;
  string wiki_page_id = 2;

  // Discord identifiers
  string message_id = 3;
  string channel_id = 4;
  string guild_id = 5;

  // Captured message content (snapshot at time of reference)
  string content = 6;
  string author_id = 7;
  string author_username = 8;
  string author_display_name = 9;
  string author_avatar_url = 16; // Discord avatar URL (joined from discord_users)
  google.protobuf.Timestamp message_timestamp = 10;

  // Attachment URLs (images, files, etc)
  repeated string attachment_urls = 11;

  // Attachment metadata (content type, filename, size)
  repeated AttachmentMetadata attachments = 15;

  // Metadata
  google.protobuf.Timestamp added_at = 12;
  string added_by_user_id = 13;

  // Computed Discord link
  string discord_link = 14;
}

// AttachmentMetadata stores Discord attachment information
message AttachmentMetadata {
  string url = 1;
  string content_type = 2; // MIME type (e.g., "image/png", "video/mp4")
  string filename = 3;
  int32 width = 4; // For images/videos
  int32 height = 5; // For images/videos
  int64 size = 6; // File size in bytes
}

message AddWikiMessageReferenceRequest {
  string wiki_page_id = 1;

  // Discord identifiers
  string message_id = 2;
  string channel_id = 3;
  string guild_id = 4;

  // Message content
  string content = 5;
  string author_id = 6;
  string author_username = 7;
  string author_display_name = 8;
  google.protobuf.Timestamp message_timestamp = 9;

  // Attachment URLs (deprecated, use attachments instead)
  repeated string attachment_urls = 10;

  // Attachment metadata
  repeated AttachmentMetadata attachments = 11;
}

message ListWikiMessageReferencesRequest {
  string wiki_page_id = 1;
}

message ListWikiMessageReferencesResponse {
  repeated WikiMessageReference references = 1;
}
